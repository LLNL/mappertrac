Bootstrap: docker
From: ubuntu:18.04

%files
    license.txt /opt/freesurfer/license.txt

%post
    # Links
    MAIN_DIR=$PWD
    CUDA_VERSION=10.2-cudnn7-runtime-ubuntu18.04
    NEURODEBIAN_KEY=http://neuro.debian.net/_static/neuro.debian.net.asc
    MINICONDA=https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh

    # Linux packages
    mkdir /mappertrac
    apt-get -y update
    apt-get install -y libopenblas-dev apt-utils bzip2 ca-certificates curl locales unzip bc dc file libfontconfig1 libfreetype6 libgl1-mesa-dev libgl1-mesa-dri libglu1-mesa-dev libgomp1 libice6 libxcursor1 libxft2 libxinerama1 libxrandr2 libxrender1 libxt6 wget python2.7 python-pip python-numpy
    apt-get install -y software-properties-common
    add-apt-repository -y universe
    # sed -Ei 's/^# deb-src /deb-src /' /etc/apt/sources.list
    apt-get -y update
    apt-get -y install dcm2niix tcsh build-essential libtool kmod initramfs-tools vim-tiny dkms mricron debhelper dh-autoreconf python3.8-dev python3.8-distutils python3.8-venv libeigen3-dev zlib1g-dev
    locale-gen en_US.UTF-8
    rm /bin/sh
    ln -s /bin/bash /bin/sh

    # FSL
    apt-get clean
    rm -rf /var/lib/apt/lists/*
    echo "Downloading FSL ..." && mkdir -p /opt/fsl-6.0.5.1 && curl -fsSL --retry 5 https://fsl.fmrib.ox.ac.uk/fsldownloads/fsl-6.0.5.1-centos7_64.tar.gz | tar -xz -C /opt/fsl-6.0.5.1 --strip-components 1
    echo "Installing FSL conda environment ..." && bash /opt/fsl-6.0.5.1/etc/fslconf/fslpython_install.sh -f /opt/fsl-6.0.5.1
    pip install etelemetry nipype

    # Cleanup
    apt-get -y clean

%environment
    export FSLDIR=/opt/fsl-6.0.5.1
    FSL_DIR=$FSLDIR
    FSLOUTPUTTYPE=NIFTI_GZ
    FSLMULTIFILEQUIT=TRUE
    FSLTCLSH=${FSLDIR}/bin/fsltclsh
    FSLWISH=${FSLDIR}/bin/fslwish
    FSLGECUDAQ="cuda.q"
    FSL_BIN=${FSLDIR}/bin
    FSLLOCKDIR=""
    FSLMACHINELIST=""
    FSLREMOTECALL=""
    FS_OVERRIDE=0
    COMPILE_GPU=1
    export FSL_DIR FSLOUTPUTTYPE FSLMULTIFILEQUIT FSLTCLSH FSLWISH FSLGECUDAQ FSL_BIN FS_OVERRIDE COMPILE_GPU

    SUBJECTS_DIR=/mappertrac

    export CUDA_8_LIB_DIR=/usr/local/cuda-10.2/lib64

    export PATH="${FSLDIR}/bin:${FSLDIR}/fslpython/condabin:${FSLDIR}/fslpython/bin:$PATH"
    export LD_LIBRARY_PATH="${FSLDIR}/lib:$LD_LIBRARY_PATH"
    export OS=LINUX
